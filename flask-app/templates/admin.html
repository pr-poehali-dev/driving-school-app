{% extends "base.html" %}

{% block title %}Админ-панель - АвтоПрофи{% endblock %}

{% block content %}
<section class="admin-section">
    <div class="container">
        <div id="loginForm" class="login-container">
            <h2>Вход в админ-панель</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Войти</button>
            </form>
        </div>

        <div id="adminPanel" class="admin-panel" style="display: none;">
            <div class="admin-header">
                <h1>Админ-панель</h1>
                <button id="logoutBtn" class="btn btn-secondary">Выйти</button>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="enrollments">Заявки</button>
                <button class="tab-btn" data-tab="courses">Курсы</button>
                <button class="tab-btn" data-tab="instructors">Инструкторы</button>
            </div>

            <div id="enrollments-tab" class="tab-content active">
                <h2>Заявки на обучение</h2>
                <div id="enrollmentsList" class="data-list"></div>
            </div>

            <div id="courses-tab" class="tab-content">
                <div class="tab-header">
                    <h2>Курсы</h2>
                    <button class="btn btn-primary" onclick="showCourseForm()">Добавить курс</button>
                </div>
                <div id="coursesList" class="data-list"></div>
            </div>

            <div id="instructors-tab" class="tab-content">
                <div class="tab-header">
                    <h2>Инструкторы</h2>
                    <button class="btn btn-primary" onclick="showInstructorForm()">Добавить инструктора</button>
                </div>
                <div id="instructorsList" class="data-list"></div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const ADMIN_PASSWORD = 'AutoProfi2024!';
let isAuthenticated = false;

document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const password = document.getElementById('password').value;
    
    if (password === ADMIN_PASSWORD) {
        isAuthenticated = true;
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadAllData();
    } else {
        alert('Неверный пароль');
    }
});

document.getElementById('logoutBtn').addEventListener('click', function() {
    isAuthenticated = false;
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('password').value = '';
});

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tabName = this.dataset.tab;
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    });
});

async function loadAllData() {
    await loadEnrollments();
    await loadCourses();
    await loadInstructors();
}

async function loadEnrollments() {
    try {
        const response = await fetch('/api/enrollments');
        const data = await response.json();
        
        const container = document.getElementById('enrollmentsList');
        container.innerHTML = data.map(enrollment => `
            <div class="data-card">
                <div class="data-header">
                    <h3>${enrollment.full_name}</h3>
                    <span class="status-badge status-${enrollment.status}">${enrollment.status}</span>
                </div>
                <p><strong>Телефон:</strong> ${enrollment.phone}</p>
                ${enrollment.email ? `<p><strong>Email:</strong> ${enrollment.email}</p>` : ''}
                ${enrollment.course_title ? `<p><strong>Курс:</strong> ${enrollment.course_title}</p>` : ''}
                ${enrollment.message ? `<p><strong>Сообщение:</strong> ${enrollment.message}</p>` : ''}
                <p><strong>Дата:</strong> ${new Date(enrollment.created_at).toLocaleString('ru-RU')}</p>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading enrollments:', error);
    }
}

async function loadCourses() {
    try {
        const response = await fetch('/api/courses');
        const data = await response.json();
        
        const container = document.getElementById('coursesList');
        container.innerHTML = data.map(course => `
            <div class="data-card">
                <div class="data-header">
                    <h3>${course.title}</h3>
                    <span class="course-badge">${course.category}</span>
                </div>
                <p>${course.description}</p>
                <p><strong>Длительность:</strong> ${course.duration}</p>
                <p><strong>Цена:</strong> ${course.price.toLocaleString()} ₽</p>
                <p><strong>Особенности:</strong></p>
                <ul>
                    ${course.features.map(f => `<li>${f}</li>`).join('')}
                </ul>
                <div class="data-actions">
                    <button class="btn btn-secondary btn-sm" onclick="deleteCourse(${course.id})">Удалить</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading courses:', error);
    }
}

async function loadInstructors() {
    try {
        const response = await fetch('/api/instructors');
        const data = await response.json();
        
        const container = document.getElementById('instructorsList');
        container.innerHTML = data.map(instructor => `
            <div class="data-card">
                <h3>${instructor.name}</h3>
                <p><strong>Специализация:</strong> ${instructor.specialization}</p>
                <p><strong>Опыт:</strong> ${instructor.experience} лет</p>
                <p><strong>Рейтинг:</strong> ${instructor.rating}</p>
                <p>${instructor.bio}</p>
                <div class="data-actions">
                    <button class="btn btn-secondary btn-sm" onclick="deleteInstructor(${instructor.id})">Удалить</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading instructors:', error);
    }
}

async function deleteCourse(id) {
    if (confirm('Удалить курс?')) {
        try {
            await fetch(`/api/courses?id=${id}`, { method: 'DELETE' });
            await loadCourses();
        } catch (error) {
            console.error('Error deleting course:', error);
        }
    }
}

async function deleteInstructor(id) {
    if (confirm('Удалить инструктора?')) {
        try {
            await fetch(`/api/instructors?id=${id}`, { method: 'DELETE' });
            await loadInstructors();
        } catch (error) {
            console.error('Error deleting instructor:', error);
        }
    }
}
</script>
{% endblock %}
